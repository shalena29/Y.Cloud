
<!-- Output copied to clipboard! -->

# Миграция сайта WordPress на Yandex.Cloud

С помощью этой инструкции вы научитесь переносить сайт WordPress в Yandex.Cloud.

Чтобы перенести сайт Wordpress в Yandex.Cloud:

1. [Подготовьте Yandex.Cloud к работе](#подготовьте-yandex-cloud-к-работе).    
1. [Подготовьте сайт WordPress к переносу в Yandex.Cloud](#подготовьте-сайт-wordPress-к-переносу-в-yandexcloud).   
1. [Перенесите файлы сайта в Yandex.Cloud](#перенесите-файлы-сайта-в-yandexcloud). 
1. [Настройте DNS](#настройте-DNS).    
1. [Создайте SSL-сертификат для сайта c помощью Let’s Encrypt в Yandex.Cloud](#Создайте-ssl-сертификат-для-сайта-c-помощью-lets-encrypt-в-yandexcloud).    
1. [Проверьте работу сайта](#Проверьте-работу-сайта). 

Если сайт вам больше не нужен,[ удалите все используемые им ресурсы](#Как-удалить-созданные-ресурсы).


## <a id="подготовьте-yandex-cloud-к-работе"></a>**Подготовьте Yandex.Cloud к работе**

Перед началом работы, необходимо зарегистрироваться в Yandex.Cloud и создать платежный аккаунт:

1. Перейдите в[ консоль управления](https://console.cloud.yandex.ru/), затем войдите в Yandex.Cloud или зарегистрируйтесь, если вы еще не зарегистрированы.
2. [На странице биллинга](https://console.cloud.yandex.ru/billing) убедитесь, что у вас подключен[ платежный аккаунт](https://cloud.yandex.ru/docs/billing/concepts/billing-account), и он находится в статусе `ACTIVE` или `TRIAL_ACTIVE`. Если платежного аккаунта нет,[ создайте его](https://cloud.yandex.ru/docs/billing/quickstart/).

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша виртуальная машина (ВМ), на[ странице облака](https://console.cloud.yandex.ru/cloud).

[Подробнее об облаках и каталогах](https://cloud.yandex.ru/docs/resource-manager/concepts/resources-hierarchy).

### **Необходимые платные ресурсы** 

В стоимость поддержки ВМ будет входить:

* Плата за постоянно запущенную ВМ (см.[ тарифы Yandex Compute Cloud](https://cloud.yandex.ru/docs/compute/pricing)).
* Плата за использование динамического или статического внешнего IP-адреса (см.[ тарифы Yandex Virtual Private Cloud](https://cloud.yandex.ru/docs/vpc/pricing)).

### Создайте виртуальную машину для WordPress

Чтобы создать виртуальную машину (ВМ):

1. На странице каталога в[ консоли управления](https://console.cloud.yandex.ru/) нажмите кнопку **Создать ресурс** и выберите **Виртуальная машина**.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/createvm.png "Нажмите кнопку Создать ресурс и выберите Виртуальная машина")

2. В поле **Имя** введите имя ВМ:
    * Длина — от 3 до 63 символов.
    * Может содержать строчные буквы латинского алфавита, цифры и дефисы.
    * Первый символ — буква. Последний символ — не дефис.

3. Выберите[ зону доступности](https://cloud.yandex.ru/docs/overview/concepts/geo-scope), в которой будет находиться ВМ.

4. В блоке **Образы из Cloud Marketplace** нажмите кнопку **Выбрать**. Выберите публичный образ **LAMP**, который включает в себя операционную систему семейства Linux, веб-сервер Apache, СУБД MySQL и интерпретатор PHP (Linux, Apache, MySQL, PHP — сокращённо LAMP).


![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/cloud-marketplace-lamp.png "Выберите публичный образ LAMP")


5. В блоке **Вычислительные ресурсы**:

    * Выберите[ ](https://cloud.yandex.ru/docs/compute/concepts/vm-platforms)**Платформу** ВМ.
    * Укажите необходимое количество **vCPU** и объем **RAM**.

    Для небольшого сайта хватит минимальной конфигурации: 

    * **Платформа** — Intel Cascade Lake.
    * **Гарантированная доля vCPU** — 5%.
    * **vCPU** — 2.
    * **RAM** — 1 ГБ.

Справа вы можете видеть предварительный расчет стоимости ВМ в зависимости от выбранных параметров.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/cost.png "Предварительный расчет стоимости  ВМ")

6. В блоке **Сетевые настройки** оставьте значения по умолчанию в полях **Сеть** и **Подсеть**. Яндекс автоматически выделит вам IP-адрес, который при необходимости сможете зарезервировать за собой на постоянной основе за дополнительную плату.
7. В поле **Публичный адрес** оставьте значение **Автоматически**, чтобы назначить ВМ случайный внешний IP-адрес из пула Yandex.Cloud, или выберите статический адрес из списка, если вы зарезервировали его заранее.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/netsource.png "Публичный адрес")

8. Укажите данные для доступа к ВМ: 

    * В поле **Логин** введите имя пользователя. 

    * В поле **SSH-ключ** вставьте содержимое файла открытого ключа.

Пару ключей для подключения по SSH необходимо создать самостоятельно, см. раздел[ Подключиться к виртуальной машине Linux по SSH](https://cloud.yandex.ru/docs/compute/operations/vm-connect/ssh).

**Внимание**

IP-адрес и имя хоста для подключения к ВМ назначаются автоматически при ее создании. Если вы выбрали вариант **Без адреса** в поле **Публичный адрес**, то не сможете обращаться к ВМ извне.

9. Нажмите кнопку **Создать ВМ**.

Создание ВМ может занять несколько минут. Когда ВМ перейдет в статус `RUNNING`, можете переходить к следующему шагу.

При создании ВМ автоматически назначается публичный IP-адрес и имя хоста. Эти данные можно использовать для доступа по SSH.

### Подключение к виртуальной машине в Yandex.Cloud 

Вы можете подключиться к виртуальной машине (ВМ) по протоколу SSH. Для этого можно использовать встроенные в Linux/macOS/Windows 10 утилиты или специальные программы для Windows 7/8, например [PuTTY](https://www.chiark.greenend.org.uk/~sgtatham/putty/).

1. Выберите созданную ВМ и перейдите в блок **Сеть**.
2. Найдите **Публичный IPv4** — это общедоступный IP-адрес вашего сайта.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/publicipv4.png "Публичный IPv4")

Если вы создали машину только с внутренним адресом, для доступа через интернет нужно создать новую машину с публичным адресом.

3. Скопируйте **Публичный IPv4.**
4. Подключитесь к ВМ из консоли ранее выбранной утилиты:
```html
ssh <имя_пользователя>@<публичный_IP-адрес_виртуальной машины> 
```

При подключении к ВМ первый раз вы увидите предупреждение о неизвестном хосте. Пример такого сообщения:
```
The authenticity of host '84.203.131.180 (84.203.131.180)' can't be established.
ECDSA key fingerprint is SHA256:ALLLGwj+KptZ8zWG4sZADX9giOUN9LWW5cz0ocA/zqg.
Are you sure you want to continue connecting (yes/no)?
```
Наберите `yes` и нажмите `Enter`.

### Установите дополнительные компоненты 

Прежде чем перейти к переносу файлов в Yandex.Cloud, необходимо установить дополнительные компоненты через SSH:

1. Установите редактор `Nano` для внесения правок в файлы конфигурации:
```
$ sudo apt-get update
$ sudo apt install nano
```
Дождитесь завершения операции. 

2. Установите и настройте **phpMyAdmin** (веб-приложение для администрирования баз данных через браузер), т.к. по умолчанию он не установлен в LAMP-образе:
<pre><code>$ sudo apt-get install phpmyadmin php-mbstring php-gettext</code></pre>
В процессе установки появятся несколько вопросов, на которые необходимо будет дать ответы.

Первый вопрос — выбор сервера, на который вы устанавливаете phpMyAdmin. Будьте очень внимательны на данном шаге, необходимо подсветить Apache2 и нажать пробел, чтобы выбрать его. Напротив Apache2 появится звездочка `*`. Нажмите `Enter`.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/apache1.png "Выбор сервера.")

Второй вопрос про настройку доступа к БД. Необходимо выбрать **`Yes`** и задать пароль администратора.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/apache2.png "Настройка доступа к БД")

3. Скачайте и сохраните сгенерированный системой пароль:
<pre><code>$ sudo cat /root/default_passwords.txt</code></pre>
Эти данные вам понадобятся для входа в **phpMyAdmin**.

4. Установите расширения PHP:
<pre><code>$ sudo phpenmod mcrypt
$ sudo phpenmod mbstring</code></pre>
5. Перезапустите Apache, чтобы все сделанные изменения вступили в силу:
<pre><code>$ sudo systemctl restart apache2</code></pre>
Перейдите по адресу: [http://0.0.0.0/phpmyadmin](http://0.0.0.0/phpmyadmin) (впишите свой публичный IP вместо 0.0.0.0). 

По умолчанию используйте пользователя `root` с паролем, который ранее записали и сохранили в текстовый файл `default_passwords.txt`.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/phpmyadmin-root.png "Используйте пользователя root с паролемиз текстового файла default_passwords")

### **Сделайте phpMyAdmin более безопасным**
Для защиты от несанкционированных действий необходимо ограничить доступ и создать дополнительный пароль для входа в phpMyAdmin:

1. Включите возможность использования файла `.htaccess` в вашей конфигурации. Для этого необходимо отредактировать файл `phpmyadmin.conf`:
<pre><code>$ sudo nano /etc/apache2/conf-available/phpmyadmin.conf</code></pre>
2. Добавьте директиву: `AllowOverride All` в указанном месте:
```
<Directory /usr/share/phpmyadmin>
Options FollowSymLinks
DirectoryIndex index.php
AllowOverride All
```
3. Сохраните файл.
4. Перезапустите Apache для применения изменений:
<pre><code>$ sudo systemctl restart apache2</code></pre>
5. Создайте файл `.htaccess`:
```
$ sudo nano /usr/share/phpmyadmin/.htaccess
```
6. Добавьте в `.htaccess` следующий код:
```
AuthType Basic
AuthName "Restricted Files"
AuthUserFile /etc/phpmyadmin/.htpasswd
Require valid-user
```
7. Сохраните файл.
8. Создайте файл `.htpasswd`:
```
$ sudo htpasswd -c /etc/phpmyadmin/.htpasswd username
```
Вместо `username` придумайте пользователя и введите сложный пароль два раза, запишите всё в текстовый файл и сохраните.

9. Перезапустите Apache для применения изменений:
```
$ sudo systemctl restart apache2
```
**Краткая справка:**

* `.htpasswd` — файл, содержащий пароли для доступа к ресурсу у веб-сервера Apache.
* `.htaccess` — файл, который дает возможность конфигурировать работу сервера в отдельных директориях (папках), не предоставляя доступа к главному конфигурационному файлу.

Перейдите по адресу: [http://0.0.0.0/phpmyadmin](http://0.0.0.0/phpmyadmin) (впишите свой публичный IP вместо 0.0.0.0). 

Теперь при входе в **phpMyAdmin** вы дополнительно защищены от злоумышленников.

## <a id="подготовьте-сайт-wordPress-к-переносу-в-yandexcloud"></a>**Подготовьте сайт WordPress к переносу в Yandex.Cloud**

### Сделайте резервную копию сайта WordPress 

Сделайте резервную копию файлов сайта, а также базы данных (БД) на вашем хостинге. Выполнить это можно несколькими способами:

* С помощью различных плагинов для WordPress (BackWPup или Updraft Plus и др.).
* С помощью встроенных средств в панели управления хостингом.
* Скопировать все файлы через FTP/SFTP ([FileZilla](https://filezilla.ru/),[ FAR](https://www.farmanager.com/download.php?l=ru),[ Total Commander](https://www.ghisler.com/) и др.), а БД экспортировать через панель phpMyAdmin.

## <a id="перенесите-файлы-сайта-в-yandexcloud"></a>**Перенесите файлы сайта в Yandex.Cloud**

### Загрузите файлы сайта в Yandex.Cloud

1. Перед загрузкой файлов на ВМ нужно предоставить папке `html` права доступа на чтение, запись и исполнение. Для этого в SSH-консоли наберите команду:
```
$ sudo chmod 777 /var/www/html
```
2. Перенесите все папки и файлы своего сайта в Yandex.Cloud.

Для загрузки файлов на Yandex.Cloud можно использовать следующие протоколы:

* FTP/SFTP ([FileZilla](https://filezilla.ru/),[ FAR](https://www.farmanager.com/download.php?l=ru),[ Total Commander](https://www.ghisler.com/)).
* SSH ([Putty](https://www.putty.org/)).
3. Разархивируйте папку с файлами через SSH: 
```
$ cd /var/www/html
$ tar -xvf FILENAME.tar.gz
```
Вместо `FILENAME` укажите название файла с архивом сайта.

Все ваши файлы будут разархивированы в корневую директорию `html`.

4. Удалите файл архива:
```
$ rm FILENAME.tar.gz
```
Вместо `FILENAME` укажите название файла с архивом сайта.

5. Верните права для папки `html` и вложенных папок — 755 и отдельно для всех файлов внутри `html` — 644, а для `wp-config.php` отдельно уровень доступа — 600:
```
$ cd var/www/
$ sudo find ./ -type d -exec chmod 0755 {} \;
$ sudo find ./ -type f -exec chmod 0644 {} \;
$ sudo chmod 600 wp-config.php
```
**Справка:**

Параметр `f` — ищет все файлы внутри директорий.

Параметр `d` — ищет все директории внутри html.


### Загрузите базу данных через phpMyAdmin в Yandex.Cloud

1. Найдите файл `wp-config.php`. Он лежит в корне вашего сайта (`/var/www/html/wp-config.php`).
2. Откройте `wp-config.php` и найдите строки со значениями `DB_NAME`, `DB_USER` и `DB_PASSWORD`, которые будете использовать для создания базы данных (БД) в Yandex.Cloud:
* `DB_NAME`— название БД (`username_database`).
* `DB_USER`— имя пользователя-администратора (`username_user`).
* `DB_PASSWORD`— пароль пользователя-администратора (`MySecretPassword`).

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/wp-config.png "Найдите строки со значениями `DB_NAME`, `DB_USER` и `DB_PASSWORD`")

3. Откройте **phpMyAdmin** и войдите с данными, которые создали ранее в настройках для phpMyAdmin:

    [http://0.0.0.0/phpmyadmin](http://0.0.0.0/phpmyadmin) (вместо `0.0.0.0` вставьте свой публичный IP-адрес сайта). 

4. Перейдите в **Учетные записи пользователей** и добавьте учетную запись пользователя с параметрами:
* **Имя пользователя**: Вставьте скопированное значение `DB_USER` из `wp-config.php`.
* **Имя хоста**: Оставьте %.
* **Пароль** (2 раза): Вставьте скопированное значение `DB_PASSWORD` из `wp-config.php`.
* **Глобальные привилегии**: Выберите отметку **Отметить все** и нажмите **Вперед**, чтобы сохранить пользователя.

Все остальные параметры при создании пользователя оставьте по умолчанию.

В данными из примера, описанного выше, это будет выглядеть так:

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/add_user.png "Добавление учетной записи пользователя")

5. Перейдите в пункт: **Базы данных**. Из файла `wp-config.php` скопируйте значение после `DB_NAME` и вставьте в поле **Имя базы данных** в **phpMyAdmin.** 
6. Выберите **кодировку** `utf8_general_ci`.
7. Нажмите **Создать**.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/create-db.png "Создание базы данных")

База данных создана.

8. Выберите в левой колонке созданную БД, нажмите **Импорт** в верхнем меню, выберите файл с резервной копией БД у себя на компьютере, после чего нажмите **Вперёд**.

Готово, БД импортирована.

![alt text](https://github.com/shalena29/Y.Cloud/blob/main/ru/_assets/db-import-udb.png "Импорт базы данных успешно завершен")

## <a id="настройте-DNS"></a>**Настройте DNS**

Чтобы привязать сайт к домену, настройте DNS у вашего регистратора следующим образом:

* A-запись: поддомен `@`, в качестве адреса используйте публичный IP-адрес виртуальной машины.
* CNAME-запись: поддомен `www`, в качестве канонического имени используйте домен с точкой на конце, например: `example.com`.

Процесс обновления может занять до 3-х суток.

## <a id="Создайте-ssl-сертификат-для-сайта-c-помощью-lets-encrypt-в-yandexcloud"></a>**Создайте SSL-сертификат для сайта c помощью Let’s Encrypt в Yandex.Cloud**

SSL-сертификат позволяет шифровать трафик между пользователем и сайтом и помогает избежать кражи персональных данных при их вводе на сайте. Также сертификат увеличивает уровень доверия пользователя к сайту.

Если в адресной строке рядом с веб-адресом отображается значок замка, значит этот веб-сайт защищен с помощью SSL.

Подробнее о создании и настройках SSL-сертификата c помощью Let’s Encrypt см. [Как начать работать c Certificate Manager](https://cloud.yandex.ru/docs/certificate-manager/quickstart/). 

## <a id="Проверьте-работу-сайта"></a>**Проверьте работу сайта**

Чтобы проверить работу сайта, откройте его адрес в браузере: `http://<публичный IP-адрес виртуальной машины>`.

Проверить работу доменного имени аналогичным образом можно будет после изменения DNS-записи. Процесс обновления может занять до 3-х суток.

## <a id="Как-удалить-созданные-ресурсы"></a>**Как удалить созданные ресурсы**

Чтобы перестать пользоваться услугами, достаточно удалить[ виртуальную машину](https://cloud.yandex.ru/docs/compute/operations/vm-control/vm-delete).

Если вы зарезервировали статический публичный IP-адрес специально для этой ВМ:

1. Откройте сервис **Virtual Private Cloud** в вашем каталоге.
2. Перейдите на вкладку **IP-адреса**.
3. Найдите нужный адрес, нажмите значок ![alt text](https://github.com/yandex-cloud/docs/blob/master/ru/_assets/options.svg ) и выберите пункт **Удалить**.
